@page "/janken"
@using JankenGame.Models.Janken
@using JankenGame.Services.Janken
@rendermode InteractiveServer

<h3>ã˜ã‚ƒã‚“ã‘ã‚“ã‚²ãƒ¼ãƒ </h3>

<div class="choices">
    <button @onclick="() => Play(JankenHand.Rock)">âœŠ  ã‚°ãƒ¼</button>
    <button @onclick="() => Play(JankenHand.Paper)">âœ‹  ãƒ‘ãƒ¼</button>
    <button @onclick="() => Play(JankenHand.Scissors)">âœŒï¸  ãƒãƒ§ã‚­</button>
</div>

@if (Player.Hand != null && Computer.Hand != null)
{
    <div class="result">
        <p>ã‚ãªãŸï¼š@Player.Hand?.GetDescription() â†’ ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ï¼š@Computer.Hand?.GetDescription()</p>
        <p>@OutcomeMessage</p>
        <p>ï¼œç¾åœ¨ã®ã‚¹ã‚³ã‚¢ï¼ @RecordList.TotalWinsã€€å‹:  @RecordList.TotalLosses æ•—;ã€€@RecordList.TotalDraws å¼•ãåˆ†ã‘</p>
        <button @onclick="ResetGame">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
}

@if (RecentRecords.Any())
{
    <div class="history">
        <h4>ç›´è¿‘ã®å±¥æ­´ï¼ˆæœ€å¤§5ä»¶ï¼‰</h4>
        <ul>
            @foreach (var record in RecentRecords)
            {
                <li>
                    ã‚ãªãŸï¼š@record.PlayerHand.GetDescription() ï¼ ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ï¼š@record.ComputerHand.GetDescription() â†’ çµæœï¼š@record.Outcome.GetDescription()ï¼ˆ@record.Timestamp.ToString("HH:mm:ss")ï¼‰
                </li>
            }
        </ul>
    </div>
}

@code {
    string OutcomeMessage = "";

    JankenPlayer Player = new JankenPlayer();
    JankenPlayer Computer = new JankenPlayer();
    JankenRecordList RecordList = new JankenRecordList();
    Random rnd = new();
    JankenGameService gameService = new JankenGameService();

    IEnumerable<JankenRecord> RecentRecords => RecordList.OrderByDescending(r => r.Timestamp).Take(5);

    void Play(JankenHand userJankenHand)
    {
        Player.Hand = userJankenHand;
        Computer.Hand = (JankenHand)rnd.Next(0, 3);
        DetermineWinner();
    }

    void DetermineWinner()
    {
        if (Player.Hand == null)
        {
            OutcomeMessage = "æ‰‹ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚";
            return;
        }
        if (Computer.Hand == null)
        {
            OutcomeMessage = "ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ã®æ‰‹ã‚’æ±ºå®šä¸­...";
            return;
        }

        // ã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚‰çµæœã‚’å–å¾—
        var result = gameService.DetermineWinner(Player.Hand.Value, Computer.Hand.Value);
        RecordList.AddRecord(Player.Hand, Computer.Hand, result);

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¨­å®š
        OutcomeMessage = result switch
        {
            JankenResultEnum.Win => "ã‚ãªãŸã®å‹ã¡ï¼ğŸ‰",
            JankenResultEnum.Lose => "ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ã®å‹ã¡...",
            JankenResultEnum.Draw => "å¼•ãåˆ†ã‘ï¼",
            _ => "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ"
        };
    }

    void ResetGame()
    {
        Player = new JankenPlayer();
        Computer = new JankenPlayer();
        OutcomeMessage = "";
        RecordList.Clear();
    }
}
