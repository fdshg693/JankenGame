@page "/janken"
@using JankenGame.Models.Janken
@using JankenGame.Services.Janken
@rendermode InteractiveServer

<h3>ã˜ã‚ƒã‚“ã‘ã‚“ã‚²ãƒ¼ãƒ </h3>

<div class="game-setup">
    <div class="player-count-control">
        <label>å¯¾æˆ¦äººæ•° (ã‚ãªãŸã‚’å«ã‚€): </label>
        <select value="@selectedPlayerCount.ToString()" @onchange="OnPlayerCountChanged">
            <option value="2">2äºº</option>
            <option value="3">3äºº</option>
            <option value="4">4äºº</option>
            <option value="5">5äºº</option>
            <option value="6">6äºº</option>
        </select>
    </div>
</div>

<div class="choices">
    <button @onclick="() => Play(JankenHand.Rock)">âœŠ ã‚°ãƒ¼</button>
    <button @onclick="() => Play(JankenHand.Paper)">âœ‹ ãƒ‘ãƒ¼</button>
    <button @onclick="() => Play(JankenHand.Scissors)">âœŒï¸ ãƒãƒ§ã‚­</button>
</div>

@if (AllPlayersReady)
{
    <div class="result">
        <div class="hands-display">
            <h4>å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ‰‹</h4>
            @foreach (var player in Players)
            {
                <div class="player-hand">
                    <strong>@player.Name</strong>: @player.Hand?.GetDescription()
                </div>
            }
        </div>
        
        <div class="game-result">
            <p class="outcome-message">@OutcomeMessage</p>
            
            @if (LastWinningHand != null)
            {
                <div class="winners">
                    <p><strong>å‹è€…:</strong> @string.Join(", ", LastWinners.Select(id => Players.First(p => p.Id == id).Name))</p>
                </div>
            }
        </div>

        <button @onclick="ResetGame">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
}

<div class="score-board">
    <h4>ã‚¹ã‚³ã‚¢ãƒœãƒ¼ãƒ‰</h4>
    <table class="table">
        <thead>
            <tr>
                <th>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</th>
                <th>å‹</th>
                <th>æ•—</th>
                <th>å¼•ãåˆ†ã‘</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var player in Players)
            {
                <tr>
                    <td>@player.Name</td>
                    <td>@RecordList.GetWins(player.Id)</td>
                    <td>@RecordList.GetLosses(player.Id)</td>
                    <td>@RecordList.GetDraws(player.Id)</td>
                </tr>
            }
        </tbody>
    </table>
</div>

@if (RecentRecords.Any())
{
    <div class="history">
        <h4>ç›´è¿‘ã®å±¥æ­´ï¼ˆæœ€å¤§5ä»¶ï¼‰</h4>
        <ul>
            @foreach (var record in RecentRecords)
            {
                <li>
                    @foreach (var kvp in record.PlayerHands)
                    {
                        var playerName = Players.First(p => p.Id == kvp.Key).Name;
                        <span>@playerName: @kvp.Value.GetDescription() / </span>
                    }
                    @if (record.WinningHand != null)
                    {
                        <span>â†’ å‹ã¡æ‰‹: @record.WinningHand.Value.GetDescription()</span>
                    }
                    else
                    {
                        <span>â†’ å¼•ãåˆ†ã‘</span>
                    }
                    <span>ï¼ˆ@record.Timestamp.ToString("HH:mm:ss")ï¼‰</span>
                </li>
            }
        </ul>
    </div>
}

@code {
    private int selectedPlayerCount = 3;
    private string OutcomeMessage = "";
    private JankenHand? LastWinningHand = null;
    private List<string> LastWinners = new();

    private List<JankenPlayer> Players = new();
    private MultiPlayerGameRecordList RecordList = new();
    private Random rnd = new();
    private JankenGameService gameService = new();

    private bool AllPlayersReady => Players.All(p => p.Hand != null);
    private IEnumerable<MultiPlayerGameRecord> RecentRecords => RecordList.OrderByDescending(r => r.Timestamp).Take(5);

    protected override void OnInitialized()
    {
        InitializePlayers();
    }

    private void InitializePlayers()
    {
        Players.Clear();
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆæœ€åˆã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼‰
        Players.Add(new JankenPlayer("ã‚ãªãŸ", JankenPlayerType.Human));
        
        // ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
        for (int i = 1; i < selectedPlayerCount; i++)
        {
            Players.Add(new JankenPlayer($"ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼{i}", JankenPlayerType.Computer));
        }
    }

    private void OnPlayerCountChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int count))
        {
            selectedPlayerCount = count;
            InitializePlayers();
            ResetGame();
            StateHasChanged();
        }
    }

    private void Play(JankenHand userJankenHand)
    {
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰‹ã‚’å‡ºã™
        Players[0].Hand = userJankenHand;

        // ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ãŒæ‰‹ã‚’å‡ºã™
        for (int i = 1; i < Players.Count; i++)
        {
            Players[i].Hand = (JankenHand)rnd.Next(0, 3);
        }

        DetermineWinner();
    }

    private void DetermineWinner()
    {
        if (!AllPlayersReady)
        {
            OutcomeMessage = "æ‰‹ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚";
            return;
        }

        try
        {
            var (winningHand, winnerIds) = gameService.DetermineMultiPlayerWinner(Players);
            
            // è¨˜éŒ²ã‚’è¿½åŠ 
            var playerHands = Players.ToDictionary(p => p.Id, p => p.Hand!.Value);
            RecordList.AddRecord(playerHands, winningHand, winnerIds);

            LastWinningHand = winningHand;
            LastWinners = winnerIds;

            // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¨­å®š
            if (winningHand == null)
            {
                OutcomeMessage = "å¼•ãåˆ†ã‘ï¼";
            }
            else
            {
                var winnerNames = string.Join(", ", winnerIds.Select(id => Players.First(p => p.Id == id).Name));
                OutcomeMessage = $"{winnerNames}ã®å‹ã¡ï¼ğŸ‰";
            }
        }
        catch (Exception ex)
        {
            OutcomeMessage = $"ã‚¨ãƒ©ãƒ¼: {ex.Message}";
        }
    }

    private void ResetGame()
    {
        foreach (var player in Players)
        {
            player.Hand = null;
        }
        OutcomeMessage = "";
        LastWinningHand = null;
        LastWinners.Clear();
    }
}
