@page "/blackjack"
@using JankenGame.Models
@using JankenGame.Models.BlackJack
@using JankenGame.Services.BlackJack
@rendermode InteractiveServer

<h3>ブラックジャック</h3>

<div class="stats-board">
    <section class="player-stats">
        <h4>プレイヤー統計</h4>
        <p>勝利: @Player.Wins</p>
        <p>敗北: @Player.Losses</p>
        <p>引き分け: @Player.Draws</p>
        <p>総ゲーム数: @Player.TotalGames</p>
        <p>勝率: @Player.WinRate.ToString("F1")%</p>
    </section>

    <section class="dealer-stats">
        <h4>ディーラー統計</h4>
        <p>勝利: @Dealer.Wins</p>
        <p>敗北: @Dealer.Losses</p>
        <p>引き分け: @Dealer.Draws</p>
        <p>総ゲーム数: @Dealer.TotalGames</p>
        <p>勝率: @Dealer.WinRate.ToString("F1")%</p>
    </section>
</div>

<div class="game-board">
    <section>
        <h4>@Dealer.Name</h4>
        @foreach (var card in Dealer.Cards)
        {
            <div class="card">@card.Name</div>
        }     
        <p>スコア: @Dealer.Score</p>
    </section>

    <section>
        <h4>@Player.Name</h4>
        @foreach (var card in Player.Cards)
        {
            <div class="card">@card.Name</div>
        }
        <p>スコア: @Player.Score</p>
    </section>
</div>

<div class="controls">
    @if (!GameStarted)
    {
        <button @onclick="StartGame">ゲーム開始</button>
    }
    else if (!GameOver)
    {
        <button @onclick="Hit">ヒット</button>
        <button @onclick="Stand">スタンド</button>
    }
    else
    {
        <p class="result">@ResultMessage</p>
        <button @onclick="Reset">リセット</button>
    }
</div>

@code {
    bool GameStarted, GameOver;
    string ResultMessage = "";
    BlackJackPlayer Player = null!;
    BlackJackDealer Dealer = null!;
    
    BlackJackGameService gameService = null!;
    BlackJackLogicService logicService = null!;

    protected override void OnInitialized()
    {
        gameService = new BlackJackGameService();
        logicService = new BlackJackLogicService();
        
        Player = new BlackJackPlayer();
        Dealer = new BlackJackDealer();
        GameStarted = false;
        GameOver = false;
        ResultMessage = "";
    }

    void StartGame()
    {                
        // 初期配牌
        Player.Cards.Add(gameService.DrawCard());
        Player.Cards.Add(gameService.DrawCard());
        Dealer.Cards.Add(gameService.DrawCard());
        Dealer.Cards.Add(gameService.DrawCard());
        GameStarted = true;
        
        // ブラックジャックチェック
        if (logicService.IsBlackjack(Player.Score, Player.Cards.Count))
        {
            EndGame();
        }
    }

    void Hit()
    {
        Player.Cards.Add(gameService.DrawCard());
        if (Player.IsBust)
            EndGame();
    }

    void Stand()
    {
        // ディーラーのターン
        while (logicService.ShouldDealerHit(Dealer.Score))
        {
            Dealer.Cards.Add(gameService.DrawCard());
        }
        EndGame();
    }

    void EndGame()
    {
        GameOver = true;
        ResultMessage = logicService.DetermineWinner(
            Player.Score, 
            Dealer.Score, 
            Player.IsBust, 
            Dealer.IsBust
        );
        RecordResult(ResultMessage);
    }

    void RecordResult(string result)
    {
        if (result.Contains("プレイヤー"))
        {
            Player.RecordWin();
            Dealer.RecordLoss();
        }
        else if (result.Contains("ディーラー"))
        {
            Player.RecordLoss();
            Dealer.RecordWin();
        }
        else
        {
            Player.RecordDraw();
            Dealer.RecordDraw();
        }
    }

    void Reset()
    {
        GameStarted = false;
        GameOver = false;
        gameService.ReturnCards(Player, Dealer);
        Player.ResetCards();
        Dealer.ResetCards();
    }
}
