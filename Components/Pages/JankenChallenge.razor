@page "/janken-challenge"
@using JankenGame.Models.Janken
@using JankenGame.Services.Janken
@rendermode InteractiveServer

<PageTitle>ã˜ã‚ƒã‚“ã‘ã‚“ãƒãƒ£ãƒ¬ãƒ³ã‚¸</PageTitle>

<div class="challenge-container">
    <h3>ã˜ã‚ƒã‚“ã‘ã‚“ãƒãƒ£ãƒ¬ãƒ³ã‚¸ ğŸ¯</h3>
    <p class="description">ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ã®æ‰‹ã«å‹ã¤æ‰‹ã‚’é¸ã‚“ã§ãã ã•ã„ï¼</p>

    @if (!game.IsPlaying)
    {
        <div class="start-screen">
            <div class="rules">
                <h4>ãƒ«ãƒ¼ãƒ«</h4>
                <ul>
                    <li>ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ãŒå‡ºã—ãŸæ‰‹ã«å¯¾ã—ã¦ã€å‹ã¤æ‰‹ã‚’é¸ã³ã¾ã™</li>
                    <li>æ­£è§£ã™ã‚‹ã¨ <strong>+10ãƒã‚¤ãƒ³ãƒˆ</strong></li>
                    <li>ä¸æ­£è§£ã ã¨ <strong>-5ãƒã‚¤ãƒ³ãƒˆ</strong></li>
                    <li>ä½•å›ã§ã‚‚æŒ‘æˆ¦ã§ãã¾ã™ï¼</li>
                </ul>
            </div>
            <button class="btn-start" @onclick="StartGame">ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>

            @if (game.PlayCount > 0)
            {
                <div class="final-result">
                    <h4>æœ€çµ‚çµæœ</h4>
                    <div class="result-stats">
                        <div class="stat-item">
                            <span class="stat-label">æœ€çµ‚ã‚¹ã‚³ã‚¢</span>
                            <span class="stat-value score">@game.Score</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">ãƒ—ãƒ¬ã‚¤å›æ•°</span>
                            <span class="stat-value">@game.PlayCount</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">æ­£è§£</span>
                            <span class="stat-value correct">@game.CorrectCount</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">ä¸æ­£è§£</span>
                            <span class="stat-value wrong">@game.WrongCount</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">æ­£è§£ç‡</span>
                            <span class="stat-value">@game.GetAccuracyRate().ToString("F1")%</span>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="game-screen">
            <div class="score-board">
                <div class="score-item">
                    <span class="label">ã‚¹ã‚³ã‚¢</span>
                    <span class="value">@game.Score</span>
                </div>
                <div class="score-item">
                    <span class="label">ãƒ—ãƒ¬ã‚¤å›æ•°</span>
                    <span class="value">@game.PlayCount</span>
                </div>
                <div class="score-item">
                    <span class="label">æ­£è§£ç‡</span>
                    <span class="value">@game.GetAccuracyRate().ToString("F1")%</span>
                </div>
            </div>

            @if (game.ComputerHand == null)
            {
                <div class="question-area">
                    <p class="instruction">æº–å‚™ã¯ã„ã„ã§ã™ã‹ï¼Ÿ</p>
                    <button class="btn-next" @onclick="GenerateNewChallenge">æ¬¡ã®å•é¡Œ</button>
                </div>
            }
            else if (showResult)
            {
                <div class="answer-area">
                    <div class="computer-hand">
                        <p class="label">ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ã®æ‰‹</p>
                        <p class="hand-display">@GetHandEmoji(game.ComputerHand.Value) @game.ComputerHand.Value.GetDescription()</p>
                    </div>

                    @if (isCorrect)
                    {
                        <div class="result-message correct">
                            <p class="emoji">ğŸ‰</p>
                            <p class="message">æ­£è§£ï¼ +10ãƒã‚¤ãƒ³ãƒˆ</p>
                            <p class="detail">ã‚ãªãŸã®ç­”ãˆ: @(playerSelectedHand?.GetDescription() ?? "")</p>
                        </div>
                    }
                    else
                    {
                        <div class="result-message wrong">
                            <p class="emoji">ğŸ˜¢</p>
                            <p class="message">ä¸æ­£è§£... -5ãƒã‚¤ãƒ³ãƒˆ</p>
                            <p class="detail">ã‚ãªãŸã®ç­”ãˆ: @(playerSelectedHand?.GetDescription() ?? "")</p>
                            <p class="detail">æ­£è§£ã¯: @challengeService.GetWinningHand(game.ComputerHand.Value).GetDescription()</p>
                        </div>
                    }

                    <button class="btn-next" @onclick="NextChallenge">æ¬¡ã®å•é¡Œ</button>
                </div>
            }
            else
            {
                <div class="question-area">
                    <div class="computer-hand">
                        <p class="label">ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ãƒ¼ã®æ‰‹</p>
                        <p class="hand-display">@GetHandEmoji(game.ComputerHand.Value) @game.ComputerHand.Value.GetDescription()</p>
                    </div>

                    <p class="instruction">å‹ã¤æ‰‹ã‚’é¸ã‚“ã§ãã ã•ã„ï¼</p>

                    <div class="choices">
                        <button class="btn-choice" @onclick="() => SelectHand(JankenHand.Rock)">
                            <span class="emoji">âœŠ</span>
                            <span class="label">ã‚°ãƒ¼</span>
                        </button>
                        <button class="btn-choice" @onclick="() => SelectHand(JankenHand.Paper)">
                            <span class="emoji">âœ‹</span>
                            <span class="label">ãƒ‘ãƒ¼</span>
                        </button>
                        <button class="btn-choice" @onclick="() => SelectHand(JankenHand.Scissors)">
                            <span class="emoji">âœŒï¸</span>
                            <span class="label">ãƒãƒ§ã‚­</span>
                        </button>
                    </div>
                </div>
            }

            <div class="game-controls">
                <button class="btn-end" @onclick="EndGame">ã‚²ãƒ¼ãƒ çµ‚äº†</button>
            </div>
        </div>
    }
</div>

@code {
    private JankenChallengeGame game = new();
    private JankenChallengeService challengeService = new();
    private bool showResult = false;
    private bool isCorrect = false;
    private JankenHand? playerSelectedHand = null;

    /// <summary>
    /// ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã™ã‚‹
    /// </summary>
    private void StartGame()
    {
        game.StartGame();
        showResult = false;
        playerSelectedHand = null;
    }

    /// <summary>
    /// æ–°ã—ã„ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’ç”Ÿæˆã™ã‚‹
    /// </summary>
    private void GenerateNewChallenge()
    {
        var computerHand = challengeService.GenerateComputerHand();
        game.SetComputerHand(computerHand);
        showResult = false;
        playerSelectedHand = null;
    }

    /// <summary>
    /// ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒæ‰‹ã‚’é¸æŠã—ãŸã¨ãã®å‡¦ç†
    /// </summary>
    /// <param name="hand">é¸æŠã—ãŸæ‰‹</param>
    private void SelectHand(JankenHand hand)
    {
        if (game.ComputerHand == null) return;

        playerSelectedHand = hand;
        isCorrect = challengeService.IsCorrectAnswer(hand, game.ComputerHand.Value);

        if (isCorrect)
        {
            game.OnCorrectAnswer();
        }
        else
        {
            game.OnWrongAnswer();
        }

        showResult = true;
    }

    /// <summary>
    /// æ¬¡ã®ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã«é€²ã‚€
    /// </summary>
    private void NextChallenge()
    {
        GenerateNewChallenge();
    }

    /// <summary>
    /// ã‚²ãƒ¼ãƒ ã‚’çµ‚äº†ã™ã‚‹
    /// </summary>
    private void EndGame()
    {
        game.EndGame();
        showResult = false;
    }

    /// <summary>
    /// æ‰‹ã«å¯¾å¿œã™ã‚‹çµµæ–‡å­—ã‚’å–å¾—ã™ã‚‹
    /// </summary>
    /// <param name="hand">æ‰‹</param>
    /// <returns>çµµæ–‡å­—</returns>
    private string GetHandEmoji(JankenHand hand)
    {
        return hand switch
        {
            JankenHand.Rock => "âœŠ",
            JankenHand.Paper => "âœ‹",
            JankenHand.Scissors => "âœŒï¸",
            _ => ""
        };
    }
}
